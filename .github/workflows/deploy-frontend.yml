name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - 'Dockerfile'
      - 'nginx.conf'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy Frontend to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "ğŸ”„ Starting frontend deployment..."
            
            # Navigate to frontend directory
            cd /opt/nxtclass-frontend || exit 1
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest frontend code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Stop frontend service
            echo "â¸ï¸  Stopping frontend..."
            docker-compose stop frontend
            
            # Build new image
            echo "ğŸ—ï¸  Building frontend image..."
            docker-compose build frontend --no-cache
            
            # Start frontend service
            echo "â–¶ï¸  Starting frontend..."
            docker-compose up -d frontend
            
            # Wait for service to be ready
            echo "â³ Waiting for frontend to start..."
            sleep 15
            
            # Check health
            echo "ğŸ¥ Checking frontend health..."
            curl -f http://localhost/health || echo "Warning: Health check failed"
            
            # Cleanup
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Frontend deployment complete!"
            
            # Show status
            echo "ğŸ“Š Frontend status:"
            docker-compose ps frontend

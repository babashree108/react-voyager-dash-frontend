name: Deploy Backend to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'pom.xml'
      - 'Dockerfile'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy Backend to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "ğŸ”„ Starting backend deployment..."
            
            # Navigate to backend directory
            cd /opt/nxtclass-backend || exit 1
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest backend code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Stop backend service
            echo "â¸ï¸  Stopping backend..."
            docker-compose stop backend
            
            # Build new image
            echo "ğŸ—ï¸  Building backend image..."
            docker-compose build backend --no-cache
            
            # Start backend service
            echo "â–¶ï¸  Starting backend..."
            docker-compose up -d backend
            
            # Wait for service to be ready
            echo "â³ Waiting for backend to start..."
            sleep 30
            
            # Check health
            echo "ğŸ¥ Checking backend health..."
            curl -f http://localhost:8080/actuator/health || echo "Warning: Health check failed"
            
            # Cleanup
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Backend deployment complete!"
            
            # Show status
            echo "ğŸ“Š Backend status:"
            docker-compose ps backend

name: Deploy Backend to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'pom.xml'
      - 'Dockerfile'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🚀 Deploy Backend to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "🔄 Starting backend deployment..."
            
            # Navigate to backend directory
            cd /opt/nxtclass-backend || exit 1
            
            # Pull latest changes
            echo "📥 Pulling latest backend code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Stop backend service
            echo "⏸️  Stopping backend..."
            docker-compose stop backend
            
            # Build new image
            echo "🏗️  Building backend image..."
            docker-compose build backend --no-cache
            
            # Start backend service
            echo "▶️  Starting backend..."
            docker-compose up -d backend
            
            # Wait for service to be ready
            echo "⏳ Waiting for backend to start..."
            sleep 30
            
            # Check health
            echo "🏥 Checking backend health..."
            curl -f http://localhost:8080/actuator/health || echo "Warning: Health check failed"
            
            # Cleanup
            echo "🧹 Cleaning up old images..."
            docker image prune -f
            
            echo "✅ Backend deployment complete!"
            
            # Show status
            echo "📊 Backend status:"
            docker-compose ps backend
